---
title: 'Preprocessing'
author: 'Maud Van Ginneken'
output:
  pdf_document:
    number_sections: yes
    keep_tex: yes
  html_document:
    df_print: paged
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, autodep = TRUE, warning = FALSE, 
                      message = FALSE, echo = FALSE, eval = TRUE, tidy = TRUE,
                      fig.width = 6, fig.height = 3.5, purl = TRUE, 
                      fig.show = "hold", fig.pos = "p")
```

R Packages we will need:

```{r}
#install.packages("reticulate")
#install.packages("tidyverse")
#install.packages("Seurat")
#install.packages("pheatmap")

```

```{r}
#if (!require("BiocManager", quietly = TRUE))
    #install.packages("BiocManager")
#BiocManager::install("SingleCellExperiment")
#BiocManager::install("scater")
#BiocManager::install("destiny")
#BiocManager::install("slingshot")
#BiocManager::install("tradeSeq")
```

```{r}
library("reticulate")
library("SingleCellExperiment")
library("scater")
library("Seurat")
library("tidyverse")
library("destiny")
library("rgl")
library("car")
library("gridExtra")
library("pheatmap")
library("tibble")
library("reshape2")
#library("slingshot")
#library("tradeSeq")
```

Python packages for PaCMAP (Pairwise Controlled Manifold Approximation)  (you can install these in the terminal (not console) in RStudio with 'pip install *package name*')

- pacmap, pandas and numpy

You can test if these packages are working by running the following code:

```{r}
#library(reticulate)
#python_pandas <- import("pandas")
#python_pacmap <- import("pacmap")
#python_numpy <- import("numpy")
```

\tableofcontents

# Introduction

We will use the Seurat 'ecosystem' in R for our preprocessing workflow:

We create a Seurat object from a count matrix (a big matrix storing all RNA transcript counts for every cell). The object serves as a container that contains both data (like the count matrix) and analysis results (like PCA or clustering results) for a single-cell dataset. See: https://satijalab.org/seurat/articles/pbmc3k_tutorial.html

Ref: similar workflow (on the same dataset) in Python using Scanpy: https://training.galaxyproject.org/training-material/topics/single-cell/tutorials/scrna-plant/tutorial.html

# Data

```{r}
#Load dataset
counts_wt <- read_csv("../data/Denyer2019/GSE123818_Root_single_cell_wt_datamatrix.csv.gz")
```

```{r}
geneNames_wt <- counts_wt$...1
counts_wt <- counts_wt[-c(1)]
rownames(counts_wt) <- geneNames_wt

```

# QC metrics, data normalization, scaling, feature selection

```{r}
# Initialize the Seurat object with the raw (non-normalized data).
AT_root <- CreateSeuratObject(counts = counts_wt, project = "AT_root")
AT_root

```

```{r}
# The [[ operator can add columns to object metadata. This is a great place to stash QC stats
AT_root[["percent.mt"]] <- PercentageFeatureSet(AT_root, pattern = "^ATM")
AT_root[["percent.clp"]] <- PercentageFeatureSet(AT_root, pattern = "^ATC")


# Visualize QC metrics as a violin plot
VlnPlot(AT_root, features = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.clp"), ncol = 4)
```
```{r}
# FeatureScatter is typically used to visualize feature-feature relationships, but can be used
# for anything calculated by the object, i.e. columns in object metadata, PC scores etc.

plot1 <- FeatureScatter(AT_root, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(AT_root, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot3 <- FeatureScatter(AT_root, feature1 = "nCount_RNA", feature2 = "percent.clp")
plot1 + plot2 + plot3
```

